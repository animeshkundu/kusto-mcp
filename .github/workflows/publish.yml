name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Bump version
        id: version
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          path = Path("pyproject.toml")
          data = path.read_text()
          match = re.search(r'^version\s*=\s*"([^"]+)"', data, re.M)
          if not match:
              raise SystemExit("Version not found in pyproject.toml")
          current = match.group(1)
          parts = current.split(".")
          if len(parts) != 3 or not all(part.isdigit() for part in parts):
              raise SystemExit(
                  f"Version must follow semantic versioning (major.minor.patch): {current}"
              )
          major, minor, patch = map(int, parts)
          new_version = f"{major}.{minor}.{patch + 1}"
          updated = re.sub(
              r'^version\s*=\s*"[^"]+"',
              f'version = "{new_version}"',
              data,
              count=1,
              flags=re.M,
          )
          path.write_text(updated)
          with open(os.environ["GITHUB_OUTPUT"], "a") as output:
              output.write(f"version={new_version}\n")
              output.write(f"tag=v{new_version}\n")
          PY

      - name: Install and test
        run: |
          uv sync --dev
          uv run pytest -v

      - name: Build package
        run: uv build

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git push

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" dist/* \
            --title "${{ steps.version.outputs.tag }}" \
            --generate-notes
